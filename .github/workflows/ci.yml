name: CI

on:
  push:
    branches: ['main', 'master']
  pull_request:
    branches: ['main', 'master']

permissions:
  contents: read
  pull-requests: read

jobs:
  # 1. Detect Changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      formatter: ${{ steps.filter.outputs.formatter }}
      vscode: ${{ steps.filter.outputs.vscode }}
      workflow: ${{ steps.filter.outputs.workflow }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'core/**'
              - 'CMakeLists.txt'
            formatter:
              - 'formatter/**'
            vscode:
              - 'vscode/**'
            workflow:
              - '.github/workflows/**'

  # 2. Lint & Format Check (JS/TS) - Fast, no deps, always run
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable
      - name: Install dependencies
        run: pnpm install
      - name: ESLint
        run: pnpm run lint
      - name: Prettier
        run: pnpm run format:check

  # 3. Build Core native LSP server (required by VS Code extension)
  build-lsp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake (LSP server only)
        run: cmake -S core -B core/build-lsp -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF -DBUILD_CLI=OFF -DBUILD_LSP_SERVER=ON

      - name: Build LSP server
        run: cmake --build core/build-lsp -j$(nproc) --target bt_dsl_lsp_server

      - name: Upload LSP Server Artifact
        uses: actions/upload-artifact@v4
        with:
          name: core-lsp-build
          path: core/build-lsp/
          retention-days: 1

  # 4a. Lint Core (clang-format)
  lint-core-format:
    needs: changes
    if: ${{ needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable
      - name: Install dependencies
        run: pnpm install --filter @bt-dsl/core

      - name: Check clang-format
        run: pnpm --filter @bt-dsl/core format:check

  # 4b. Lint Core (clang-tidy) - split by directory for parallel execution
  lint-core-tidy:
    needs: changes
    if: ${{ needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: [lib, tools, tests]
    name: lint-core-tidy (${{ matrix.directory }})
    steps:
      - uses: actions/checkout@v4

      - name: Configure for clang-tidy
        run: cmake -S core -B core/build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy on ${{ matrix.directory }}
        run: |
          find core/${{ matrix.directory }} \( -name '*.cpp' -o -name '*.c' \) | \
            xargs -r -P$(nproc) -n1 clang-tidy -p core/build

  # 5. Core Native Build & Test (Skip if only frontend changed)
  test-core-native:
    needs: changes
    if: ${{ needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake (with WERROR)
        run: cmake -S core -B core/build -DCMAKE_BUILD_TYPE=Release

      - name: Build Core Native
        run: cmake --build core/build -j$(nproc)

      - name: Test Core Native
        run: cd core/build && ctest --output-on-failure

  # 6. Core Sanitizer Tests
  test-core-sanitizers:
    needs: changes
    if: ${{ needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake (with Sanitizers)
        run: cmake -S core -B core/build-san -DCMAKE_BUILD_TYPE=Debug -DENABLE_SANITIZERS=ON

      - name: Build Core with Sanitizers
        run: cmake --build core/build-san -j$(nproc)

      - name: Test Core with Sanitizers
        run: cd core/build-san && ctest --output-on-failure

  # 7. Build Core WASM
  build-wasm:
    needs: changes
    if: ${{ needs.changes.outputs.core == 'true' || needs.changes.outputs.formatter == 'true' || needs.changes.outputs.vscode == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'

      - name: Install dependencies
        run: pnpm install

      - name: Build WASM
        run: pnpm --filter @bt-dsl/core build:wasm

      - name: Upload WASM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-wasm-build
          path: core/build-wasm/
          retention-days: 1

  # 8. Build Formatter
  build-formatter:
    needs: [changes, build-wasm]
    if: ${{ needs.changes.outputs.formatter == 'true' || needs.changes.outputs.vscode == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable

      - name: Download WASM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-wasm-build
          path: core/build-wasm

      - name: Install dependencies
        run: pnpm install

      - name: Build Formatter
        run: pnpm --filter @bt-dsl/formatter build

      - name: Upload Formatter Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: formatter-build
          path: formatter/
          retention-days: 1

  # 9. Test Formatter
  test-formatter:
    needs: [changes, build-formatter]
    if: ${{ needs.changes.outputs.formatter == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable

      - name: Download Formatter Artifacts
        uses: actions/download-artifact@v4
        with:
          name: formatter-build
          path: formatter

      - name: Download WASM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-wasm-build
          path: core/build-wasm

      - name: Install dependencies
        run: pnpm install

      - name: Test Formatter
        run: pnpm --filter @bt-dsl/formatter test

  # 10. Test VS Code Extension
  test-vscode:
    needs: [changes, build-lsp, build-formatter]
    if: ${{ needs.changes.outputs.vscode == 'true' || needs.changes.outputs.formatter == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable

      - name: Download LSP Server Artifact
        uses: actions/download-artifact@v4
        with:
          name: core-lsp-build
          path: core/build-lsp

      - name: Download Formatter Artifacts
        uses: actions/download-artifact@v4
        with:
          name: formatter-build
          path: formatter

      - name: Download WASM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-wasm-build
          path: core/build-wasm

      - name: Make LSP server executable
        run: chmod +x core/build-lsp/bt_dsl_lsp_server

      - name: Install dependencies
        run: pnpm install

      - name: Build & Test VS Code Extension
        run: |
          pnpm --filter bt-dsl-vscode prebuild
          pnpm --filter bt-dsl-vscode build
          pnpm --filter bt-dsl-vscode test

  # 11. E2E Tests (VS Code Extension)
  test-e2e:
    needs: [changes, build-lsp, build-formatter]
    if: ${{ needs.changes.outputs.vscode == 'true' || needs.changes.outputs.formatter == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable

      - name: Download LSP Server Artifact
        uses: actions/download-artifact@v4
        with:
          name: core-lsp-build
          path: core/build-lsp

      - name: Download Formatter Artifacts
        uses: actions/download-artifact@v4
        with:
          name: formatter-build
          path: formatter

      - name: Download WASM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-wasm-build
          path: core/build-wasm

      - name: Make LSP server executable
        run: chmod +x core/build-lsp/bt_dsl_lsp_server

      - name: Install dependencies
        run: pnpm install

      - name: Build all packages
        run: |
          pnpm --filter bt-dsl-vscode prebuild
          pnpm --filter bt-dsl-vscode build
          pnpm --filter bt-dsl-vscode compile-tests

      - name: Run E2E tests
        run: xvfb-run -a node vscode/out-test/e2e/runTest.js
        env:
          DISPLAY: ':99.0'

  # 12. Package VS Code Extension (VSIX)
  package-vscode:
    needs: [changes, build-lsp, build-formatter]
    if: ${{ needs.changes.outputs.vscode == 'true' || needs.changes.outputs.formatter == 'true' || needs.changes.outputs.core == 'true' || needs.changes.outputs.workflow == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable

      - name: Download LSP Server Artifact
        uses: actions/download-artifact@v4
        with:
          name: core-lsp-build
          path: core/build-lsp

      - name: Download Formatter Artifacts
        uses: actions/download-artifact@v4
        with:
          name: formatter-build
          path: formatter

      - name: Download WASM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-wasm-build
          path: core/build-wasm

      - name: Install dependencies
        run: pnpm install

      - name: Build VSIX Package
        run: pnpm --filter bt-dsl-vscode package

      - name: Verify VSIX was created
        run: |
          ls -la vscode/*.vsix
          test -f vscode/bt-dsl-vscode-*.vsix

      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-vsix
          path: vscode/*.vsix
          retention-days: 7
