# 4. 意味論（Semantics）

本章は、BT-DSL プログラムの意味を定義します。

---

## 4.1 基本概念

### 4.1.1 方向（Direction）

方向は読み取り権限と書き込み権限の組み合わせとして定義されます。

| 方向    | 読み取り | 書き込み |
| :------ | :------: | :------: |
| `in`    |    ✓     |    ✗     |
| `out`   |    ✗     |    ✓     |
| `inout` |    ✓     |    ✓     |

方向は以下の 3 つのコンテキストで使用されます：

| コンテキスト   | 説明                                                        |
| :------------- | :---------------------------------------------------------- |
| ポート方向     | `extern` 宣言においてノードが Blackboard にアクセスする権限 |
| パラメータ方向 | `tree` 定義において呼び出し元に公開するアクセス権限         |
| 引数方向       | 呼び出し時に明示するアクセス意図                            |

方向を省略した場合、`in` として扱われます。

### 4.1.2 左辺値（Lvalue）

**左辺値**とは、Blackboard エントリを指す式です。以下が左辺値となります：

- `var` で宣言された変数への参照
- `out` または `inout` 方向の tree パラメータへの参照

以下は左辺値ではありません：

- `in` 方向のパラメータへの参照
- `const` への参照
- リテラル
- 演算結果

### 4.1.3 変数の状態（Variable State）

Blackboard エントリは以下の 2 状態を持ちます：

| 状態      | 説明                                               |
| :-------- | :------------------------------------------------- |
| **Unset** | エントリが存在しない（初期値なしの宣言の初期状態） |
| **Set**   | エントリが存在し、有効な値を持つ                   |

Unset 状態の変数に対して読み取りアクセスを行うと、実行時エラーとなります。

---

## 4.2 名前空間とスコープ

### 4.2.1 名前空間の分離

BT-DSL は次の名前空間を持ち、互いに衝突しません：

| 名前空間   | 含まれる識別子                                                                                  |
| :--------- | :---------------------------------------------------------------------------------------------- |
| Type 空間  | 基本型（[3.1](./type-system.md#31-基本型primitive-types)）、`extern type`、`type`（エイリアス） |
| Node 空間  | `extern` ノード名、`tree` 名                                                                    |
| Value 空間 | `var`、`const`、パラメータ                                                                      |

### 4.2.2 可視性（Visibility）

| 識別子の先頭文字     | 可視性                                           |
| :------------------- | :----------------------------------------------- |
| `_` (アンダースコア) | **Private** — 定義されたファイル内でのみ参照可能 |
| その他               | **Public** — `import` した他ファイルから参照可能 |

### 4.2.3 import の解決

- 参照できるのは、取り込まれたモジュールの **Public** な宣言のみ
- **絶対パスは禁止**（先頭が `/` のパスはエラー）
- **拡張子は必須**（例: `"./foo.bt"` は可、`"./foo"` は不可）
- `./` または `../` で始まる相対パスは、import を記述したファイルのディレクトリ基準で解決
- **非推移的（non-transitive）**: 直接 import したモジュールの宣言のみが可視
- **曖昧性**: 同名の Public 宣言が複数の直接 import から導入される場合、エラー

### 4.2.4 スコープ階層

| スコープ      | 含まれる宣言                                                               |
| :------------ | :------------------------------------------------------------------------- |
| グローバル    | `extern`、`extern type`、`type`、グローバル `var`/`const`、`tree`          |
| Tree ローカル | tree パラメータ、ローカル `var`/`const`（`root` 前および `do` ブロック内） |

Tree ローカルスコープ内の宣言はすべて同一スコープに属し、tree 全体から参照可能です。

### 4.2.5 名前解決の優先順位

1. Tree ローカル
2. グローバル（当該ファイルおよび直接 import したモジュール）

同一名前空間において複数の候補が残る場合、エラーとなります。

### 4.2.6 重複とシャドウイング

- 同一スコープ・同一名前空間内で同名の宣言は禁止
- 親スコープの同名識別子のシャドウイングは禁止
- import による同名宣言の導入も重複として扱われます

### 4.2.7 前方参照

すべてのスコープで、定義順序によらず前方参照が許可されます。ただし、以下の循環参照はエラーです：

- 型エイリアスの循環定義
- 定数初期化式の循環依存
- tree の直接・間接の再帰呼び出し

---

## 4.3 バインディング

ノード呼び出し時、引数はポートに**バインド**されます。

### 4.3.1 バインドの整形式条件

引数をポートにバインドするとき、以下すべてを満たさなければなりません：

1. **方向の一致**: 引数方向はポート方向と一致しなければならない
2. **左辺値要件**: ポートが書き込み権限を持つ場合（`out` / `inout`）、引数は左辺値でなければならない
3. **型互換性**:
   - 読み取り専用（`in`）: 暗黙的変換を許容（[3.5](./type-system.md#35-互換性と変換)参照）
   - 書き込み権限あり（`out` / `inout`）: 型の完全一致が必要

### 4.3.2 tree パラメータとポートの関係

`tree` のパラメータは、その tree をノードとして呼び出すときのポートとなります。パラメータ方向がポート方向として解釈されます。

### 4.3.3 引数の省略

| ポート方向 | 省略可否                           |
| :--------- | :--------------------------------- |
| `in`       | デフォルト値がある場合のみ省略可能 |
| `out`      | 常に省略可能（副作用の破棄）       |
| `inout`    | 省略不可                           |

### 4.3.4 デフォルト値の制約

書き込み権限を持つポート/パラメータ（`out` / `inout`）にはデフォルト値を指定できません。

デフォルト値の式は[定数式](./type-system.md#344-定数式constant-expression)でなければなりません。

### 4.3.5 インライン変数宣言

`out var <identifier>` 構文により、引数位置で新しい Blackboard エントリを宣言できます。宣言された変数は Tree ローカルスコープに属します。

### 4.3.6 評価タイミング

ポート引数の式は毎 tick 評価されます。

---

## 4.4 ノードカテゴリ

ノード呼び出し時の `children_block`（[2.5.1](./syntax.md#251-ノード文)）内の各 `statement` を**子ノード**と呼びます。

| カテゴリ    | 子ノード |
| ----------- | :------: |
| `action`    |    —     |
| `condition` |    —     |
| `subtree`   |    —     |
| `control`   |  0以上   |
| `decorator` |    1     |

子ノードを持てないカテゴリは `children_block` を持てません。子ノードを持つカテゴリは `children_block` が必須です。

`tree` 定義は呼び出し時に `subtree` と同様に扱われます。

decorator の `children_block` に複数の子がある場合、暗黙の Sequence でラップされます（[4.6.4](#464-暗黙の構造implicit-structure)）。

---

## 4.5 データモデル

### 4.5.1 Blackboard

`var` により宣言されるエントリを Blackboard エントリと呼びます。Blackboard エントリは tick 間で値が保持されます。

初期値が指定されていない場合、変数は Unset 状態で初期化されます。

### 4.5.2 定数

`const` により宣言される値は不変です。初期化式は[定数式](./type-system.md#344-定数式constant-expression)でなければなりません。

---

## 4.6 実行モデル

### 4.6.1 実行ステータス

ノード実行は次のステータスを返します：

- `Success`
- `Failure`
- `Running`
- `Skip`

### 4.6.2 Tick

Tree は外部から繰り返し tick されます。1 tick で実行されるノードの順序は、構文上の子列と制御ノードの振る舞いによって規定されます。

### 4.6.3 事前条件

各ノード呼び出しには最大 1 つの事前条件を付与できます。

#### 開始時評価（Tick 開始時に一度だけ評価）

| 構文                | 真の時                      | 偽の時   |
| :------------------ | :-------------------------- | :------- |
| `@success_if(cond)` | スキップし `Success` を返す | 通常実行 |
| `@failure_if(cond)` | スキップし `Failure` を返す | 通常実行 |
| `@skip_if(cond)`    | スキップし `Skip` を返す    | 通常実行 |

#### 継続評価（Tick ごとに条件を再評価）

| 構文               | 動作                                                  |
| :----------------- | :---------------------------------------------------- |
| `@run_while(cond)` | 条件が真の間実行を継続。偽になったら `Skip` で中断    |
| `@guard(cond)`     | 条件が真の間実行を継続。偽になったら `Failure` で中断 |

`@run_while` と `@guard` は開始時に条件が偽の場合も、即座にそれぞれ `Skip` / `Failure` を返します。

事前条件によりノード本体の実行がスキップされた場合、そのノードの副作用（`out` への書き込み等）は発生しません。

### 4.6.4 暗黙の構造（Implicit Structure）

以下の構文は、指定された構造と等価な振る舞いとして定義されます：

- **Decorator の複数子**: `decorator` の `children_block` に 2 つ以上の子がある場合、それらは暗黙の Sequence でラップされます
- **do ブロック**: `do { ... }` は、Blackboard 書き込みを行い常に `Success` を返すアクションと等価です

---

## 4.7 属性（Attributes）

### 4.7.1 概要

属性は `#[name]` または `#[name(args)]` の形式で、宣言にメタデータを付与します。

### 4.7.2 ビルトイン属性

#### `#[behavior(DataPolicy, FlowPolicy)]`

`extern control` / `extern decorator` に付与し、ノードの実行特性をコンパイラに伝えます。この属性の利用方法は実装定義です。

**デフォルト値**: 省略時は `#[behavior(All, Chained)]` として扱われます。

| Policy     | 値         | 意味                                       |
| :--------- | :--------- | :----------------------------------------- |
| DataPolicy | `All`      | 親成功時、すべての子が成功している         |
| DataPolicy | `Any`      | 親成功時、いずれかの子が成功している       |
| DataPolicy | `None`     | 親成功時でも、子の状態は保証されない       |
| FlowPolicy | `Chained`  | 前の子の副作用が次の子で観測可能           |
| FlowPolicy | `Isolated` | すべての子は親開始時点の状態のみを参照可能 |
