# 4. 意味論（Semantics）

本章は、宣言、スコープ、名前解決、および実行モデルに関する意味論を定義します。

---

## 4.1 名前空間と可視性

### 4.1.1 名前空間の分離

BT-DSL は次の名前空間を持ち、互いに衝突しません。

- **Type 空間**: 基本型、`extern type`、`type`（エイリアス）
- **Node 空間**: `extern` ノード名、`tree` 名
- **Value 空間**: Blackboard（`var`）、定数（`const`）、パラメータ

### 4.1.2 可視性（Visibility）

| 識別子の先頭文字     | 可視性      |
| :------------------- | :---------- |
| `_` (アンダースコア) | **Private** — 定義されたファイル内でのみ参照可能 |
| その他               | **Public** — `import` した他ファイルから参照可能 |

### 4.1.3 import の解決

- 参照できるのは、取り込まれたモジュールの **Public** な宣言のみ
- **絶対パスは禁止**（先頭が `/` のパスはコンパイルエラー）
- **拡張子は必須**（例: `"./foo.bt"` は可、`"./foo"` は不可）
- `./` または `../` で始まる相対パスは、import を記述したファイルのディレクトリ基準で解決
- **非推移的（non-transitive）**: 直接 import したモジュールの宣言のみが可視
- **曖昧性**: 同名の Public 宣言が複数の直接 import から導入される場合、コンパイルエラー

---

## 4.2 スコープと名前解決

### 4.2.1 スコープ階層

| スコープ      | 含まれる宣言                                              |
| :------------ | :-------------------------------------------------------- |
| グローバル    | `extern`、`extern type`、`type`、グローバル `var`/`const`、`tree` |
| Tree ローカル | tree パラメータ、ローカル `var`/`const`                   |
| ブロック      | `children_block` 内の `var`/`const`、インライン `out var` |

### 4.2.2 名前解決の優先順位

1. ブロックスコープ
2. Tree ローカル
3. グローバル（当該ファイルおよび直接 import したモジュール）

同一名前空間において複数の候補が残る場合、コンパイルエラーです。

### 4.2.3 重複とシャドウイング

- 同一スコープ内で同名の宣言は禁止
- 親スコープの同名識別子のシャドウイングは**禁止**

同一スコープ内で禁止される重複：

- **Type 空間**: `extern type` 同士 / `type` 同士 / `extern type` と `type` / 基本型名との衝突
- **Node 空間**: `extern` ノード同士 / `tree` 同士 / `extern` と `tree`
- **Value 空間**: 同一スコープ内の `var`/`const`/パラメータ同士

名前空間が異なる場合は衝突しません。

### 4.2.4 宣言前参照

- ブロックスコープの Value 空間: 宣言以降でなければ参照不可
- モジュールスコープ: 定義順序は自由、前方参照を許可（ただし循環参照はエラー）

---

## 4.3 定数評価

### 4.3.1 定数式

`const` の初期化式、および `extern`/`tree` のデフォルト引数は `const_expr` でなければなりません。

### 4.3.2 `const_expr` の定義

`const_expr` は構文上は `expression` と同じ形を取りますが、コンパイル時に完全評価できる式に限られます。

**参照制約**: `const_expr` 内の `identifier` は `const` として解決されなければなりません。

**最低保証**（処理系が必ず受理すべき形）:
- リテラル（数値/真偽値/文字列/`null`）
- `const` 参照
- 括弧、単項演算（`!`、`-`）
- 二項演算（`+` `-` `*` `/` `%`、比較、論理、ビット演算）
- キャスト（ただし `extern type` へのキャストは不可）
- 配列リテラル:
  - `element_list` の各要素は `const_expr`
  - `repeat_init`（`[e; N]`）の `e` と `N` は `const_expr` で、`N` は非負整数

**禁止**: `vec![...]` や動的配列の構築

**エラー条件**: 0 除算、上限制約違反、数値範囲超過

---

## 4.4 データモデル

### 4.4.1 Blackboard

`var` により宣言されるエントリを Blackboard エントリと呼びます。Blackboard エントリは tick 間で値が保持されます。

### 4.4.2 ポート方向の意味

| 方向  | 読み取り | 書き込み | 意味                               |
| :---- | :------: | :------: | :--------------------------------- |
| `in`  | ✓        | ✗        | 開始時点の入力（スナップショット） |
| `ref` | ✓        | ✗        | ライブ参照（読み取り専用）         |
| `mut` | ✓        | ✓        | ライブ参照（読み書き）             |
| `out` | ✗        | ✓        | 成功時のみ書き込みが保証される出力 |

---

## 4.5 実行ステータス

BT-DSL のノード実行は次のステータスを持ちます。

- `Success`
- `Failure`
- `Running`
- `Skip`

---

## 4.6 制御フロー

### 4.6.1 Tick

Tree は外部から繰り返し tick されます。1 tick で実行されるノードの順序は、構文上の子列と `#[behavior(DataPolicy, FlowPolicy)]` によって規定されます。

### 4.6.2 Behavior Policies

`#[behavior(DataPolicy, FlowPolicy)]` は `extern control` / `extern decorator` に付与し、子ノードの実行特性を定義します。

**デフォルト値**: `#[behavior]` を省略した場合、`#[behavior(All, Chained)]` として扱われます。

| Policy     | 値        | 意味                                               |
| :--------- | :-------- | :------------------------------------------------- |
| DataPolicy | `All`     | 親成功時、すべての子が成功している                 |
| DataPolicy | `Any`     | 親成功時、いずれかの子が成功している（どの子かは不明） |
| DataPolicy | `None`    | 親成功時でも、子の状態は保証されない               |
| FlowPolicy | `Chained` | 前の子の書き込み結果が次の子で有効                 |
| FlowPolicy | `Isolated`| すべての子は親開始時点の状態のみを参照可能         |

### 4.6.3 事前条件

| 構文                | 動作                                       | 偽の時       |
| :------------------ | :----------------------------------------- | :----------- |
| `@success_if(cond)` | 真ならスキップし `Success` を返す          | 通常実行     |
| `@failure_if(cond)` | 真ならスキップし `Failure` を返す          | 通常実行     |
| `@skip_if(cond)`    | 真ならスキップし `Skip` を返す             | 通常実行     |
| `@run_while(cond)`  | 偽になったら中断し `Skip` を返す           | 実行継続     |
| `@guard(cond)`      | 偽になったら中断し `Failure` を返す        | 実行継続     |

事前条件によりノード本体の実行がスキップされた場合、そのノードの副作用（`out` への書き込み等）は発生しません。

### 4.6.3 暗黙の構造（Implicit Structure）

以下の構文は、指定された構造と等価な振る舞いとして定義されます。

- **Decorator の複数子**: `decorator` の `children_block` に 2 つ以上の子がある場合、それらは順次実行される（`Sequence` ノードと等価）。
- **Blackboard 操作**: `var x = expr;` および `x = expr;` は、常に `Success` を返すアクションと等価である。
