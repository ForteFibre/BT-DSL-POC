# 3. 型システム（Type System）

本章は、BT-DSL における型を規定します。

---

## 3.1 基本型（Primitive Types）

### 3.1.1 真偽値

`bool` — 値は `true` / `false` の 2 値です。

### 3.1.2 整数型

| 型名     | サイズ | 説明         |
| :------- | :----- | :----------- |
| `int8`   | 8bit   | 符号付き整数 |
| `int16`  | 16bit  | 符号付き整数 |
| `int32`  | 32bit  | 符号付き整数 |
| `int64`  | 64bit  | 符号付き整数 |
| `uint8`  | 8bit   | 符号なし整数 |
| `uint16` | 16bit  | 符号なし整数 |
| `uint32` | 32bit  | 符号なし整数 |
| `uint64` | 64bit  | 符号なし整数 |

### 3.1.3 浮動小数点型

| 型名      | サイズ | 説明             |
| :-------- | :----- | :--------------- |
| `float32` | 32bit  | 単精度浮動小数点 |
| `float64` | 64bit  | 倍精度浮動小数点 |

### 3.1.4 文字列型

`string` — UTF-8 文字列

---

## 3.2 型エイリアス

`type Name = T;` により、型 T に対する別名 Name を定義できます。

- エイリアスは**透過的**です。型検査において `Name` と `T` は区別されません。
- エイリアスの循環定義はエラーです。

---

## 3.3 外部型（Opaque Types）

`extern type` により導入される型は不透明型です。

- BT-DSL からは内部構造にアクセスできません。
- 互換性は、名前解決後に**同一の `extern type` 宣言**を指すもの同士に限定されます。
- 外部型に対する演算（算術、比較、ビット演算等）は許可されません。等価比較（`==` / `!=`）も含めすべて禁止です。

---

## 3.4 型推論

### 3.4.1 リテラルの型推論

| リテラル種別     | 初期型      | 解決方法                               |
| :--------------- | :---------- | :------------------------------------- |
| 整数リテラル     | `{integer}` | 後続の利用から推論、未確定時 `int32`   |
| 浮動小数リテラル | `{float}`   | 後続の利用から推論、未確定時 `float64` |
| 真偽値リテラル   | `bool`      | `bool`                                 |
| 文字列リテラル   | `string`    | `string`                               |

### 3.4.2 推論規則

推論は、以下の制約をすべて満たすように型を決定します：

- 型注釈がある場合、変数の型はその注釈型に従う
- 初期値がある場合、変数の型は初期値の型と互換でなければならない
- ポート引数として渡された場合、ポートの型から制約を受ける
- スコープ終了時点で型が一意に定まらない場合、エラーとする
  - ただし `{integer}` / `{float}` はデフォルト型（`int32` / `float64`）に解決される

### 3.4.3 型注釈の省略

以下の宣言では型注釈を省略できます。省略時は §3.4.2 の規則に従い推論されます：

- `var` / `const` 宣言
- tree パラメータ

型推論は宣言を含むスコープ内の使用箇所に基づきます。グローバル宣言は初期値からのみ推論されます。

### 3.4.4 定数式（Constant Expression）

`const` およびデフォルト値の初期化に使用できる式を定数式と呼びます。定数式はコンパイル時に評価されます。

**定数式として許可されるもの**:

- リテラル（整数、浮動小数点、文字列、真偽値）
- 他の `const` への参照
- 括弧式 `(expr)`
- 単項演算（`-`, `!`）
- 算術演算（`+`, `-`, `*`, `/`, `%`）
- 比較演算（`==`, `!=`, `<`, `<=`, `>`, `>=`）
- 論理演算（`&&`, `||`）
- ビット演算（`&`, `|`, `^`）
- キャスト（`as`）

**定数式として許可されないもの**:

- `var`（Blackboard エントリ）への参照
- パラメータへの参照
- `is_set` 式

---

## 3.5 互換性と変換

### 3.5.1 変換の分類

| 分類               | 適用         |
| :----------------- | :----------- |
| 暗黙的変換         | 自動適用     |
| 明示的変換（`as`） | キャスト必須 |

書き込み権限を持つポート（`inout` / `out`）では暗黙的変換も禁止され、完全一致が必要です（[4.3.1](./semantics.md#431-バインドの整形式条件)参照）。

### 3.5.2 暗黙的な拡大変換（Widening）

以下の変換は暗黙的に許可されます。

**符号付き整数**:

- `int8` → `int16` → `int32` → `int64`

**符号なし整数**:

- `uint8` → `uint16` → `uint32` → `uint64`

**浮動小数点**:

- `float32` → `float64`

### 3.5.3 明示的キャスト（`as`）

以下の変換には `as` が必要です：

- **縮小変換**: `int32` → `int8`、`float64` → `float32` など
- **整数 ↔ 浮動小数点**: `int32` → `float64`、`float64` → `int32` など
- **符号付き ↔ 符号なし**: `int32` → `uint32`、`uint8` → `int8` など

---

## 3.6 式の型規則

### 3.6.1 単項演算

| 演算子 | オペランド型                     | 結果型             |
| :----- | :------------------------------- | :----------------- |
| `-`    | 符号付き整数型または浮動小数点型 | オペランドと同じ型 |
| `!`    | `bool`                           | `bool`             |

符号なし整数型に対する単項マイナス（`-`）はエラーです。

### 3.6.2 算術演算（`+`, `-`, `*`, `/`）

両オペランドは同一カテゴリ（符号付き整数同士、符号なし整数同士、または浮動小数点同士）でなければなりません。

- 同一型の演算: 結果型はオペランドの型
- 異なるサイズの場合: 大きい方に拡大変換し、結果型はその型
- カテゴリが異なる場合: エラー（明示的な `as` キャストが必要）

### 3.6.3 剰余（`%`）

両オペランドは同一カテゴリの整数型（符号付き同士または符号なし同士）でなければなりません。異なるサイズの場合は大きい方に拡大変換されます。

### 3.6.4 比較（`<`, `<=`, `>`, `>=`）

両オペランドは同一カテゴリの数値型（符号付き整数同士、符号なし整数同士、または浮動小数点同士）。結果型は `bool` です。

文字列の順序比較は許可されません。

### 3.6.5 等価（`==`, `!=`）

両オペランドは以下のいずれかの組み合わせ：

- 同一カテゴリの数値型
- `bool` 同士
- `string` 同士

結果型は `bool` です。外部型（`extern type`）の等価比較は許可されません。

### 3.6.6 論理（`&&`, `||`）

両オペランドは `bool`。結果型は `bool` です。短絡評価されます。

### 3.6.7 ビット演算（`&`, `|`, `^`）

両オペランドは同一カテゴリの整数型（符号付き同士または符号なし同士）。異なるサイズの場合は大きい方に拡大変換されます。結果型はその型です。

### 3.6.8 キャスト式

`e as T` — S から T への明示的キャストが許容される場合、結果型は T です。

### 3.6.9 文字列演算

`+` 演算子により 2 つの `string` を連結できます。結果型は `string` です。

### 3.6.10 存在チェック式

`is_set(id)` — 指定された識別子の変数が Set 状態（[4.1.3](./semantics.md#413-変数の状態variable-state)）かどうかを返します。結果型は `bool` です。
