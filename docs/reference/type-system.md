# 型システム

本ドキュメントは BT-DSL の**型システム**を厳密に定義します。

---

## 1. 型の分類

### 1.1 基本型

BT-DSL は以下の基本型を持ちます：

| 型名      | 説明                       |
| :-------- | :------------------------- |
| `int`     | 整数型                     |
| `double`  | 浮動小数点数型             |
| `bool`    | 真偽値型                   |
| `string`  | 文字列型                   |
| `any`     | 任意型（すべての型と互換） |
| `unknown` | 未知型（型推論失敗時）     |

### 1.2 カスタム型

上記以外の型名はすべて**カスタム型**として扱われます。カスタム型は文字列としてそのまま保持され、ランタイムに解釈を委ねます。

例: `Vector3`, `Pose`, `NavGoal`

---

## 2. 型名の正規化

型名は**大文字小文字を区別しない正規化**が適用されます。

| 入力                                      | 正規化後               |
| :---------------------------------------- | :--------------------- |
| `int`, `Int`, `INT`, `integer`, `Integer` | `int`                  |
| `double`, `Double`, `float`, `Float`      | `double`               |
| `bool`, `Bool`, `boolean`, `Boolean`      | `bool`                 |
| `string`, `String`                        | `string`               |
| `any`, `Any`                              | `any`                  |
| その他                                    | そのまま（カスタム型） |

---

## 3. リテラルの型

リテラルの型は以下のように決定されます：

| リテラル種別     | 例              | 型       |
| :--------------- | :-------------- | :------- |
| 整数リテラル     | `42`, `-7`, `0` | `int`    |
| 浮動小数リテラル | `3.14`, `-0.5`  | `double` |
| 文字列リテラル   | `"hello"`, `""` | `string` |
| 真偽値リテラル   | `true`, `false` | `bool`   |

---

## 4. 型互換性

### 4.1 互換性の定義

型 `A` が型 `B` と**互換**であるとは、`A` の値を `B` が期待される場所に渡せることを意味します。

### 4.2 互換性規則

以下の条件のいずれかを満たすとき、型 `A` は型 `B` と互換です：

1. **同一型**: `A = B`
2. **any との互換**: `A = any` または `B = any`
3. **unknown との互換**: `A = unknown` または `B = unknown`
4. **数値昇格**: `A ∈ {int, double}` かつ `B ∈ {int, double}`

### 4.3 互換性マトリクス

|               | `int` | `double` | `bool` | `string` | `any` | `unknown` |  カスタム  |
| :------------ | :---: | :------: | :----: | :------: | :---: | :-------: | :--------: |
| **`int`**     |   ✓   |    ✓     |   ✗    |    ✗     |   ✓   |     ✓     |     ✗      |
| **`double`**  |   ✓   |    ✓     |   ✗    |    ✗     |   ✓   |     ✓     |     ✗      |
| **`bool`**    |   ✗   |    ✗     |   ✓    |    ✗     |   ✓   |     ✓     |     ✗      |
| **`string`**  |   ✗   |    ✗     |   ✗    |    ✓     |   ✓   |     ✓     |     ✗      |
| **`any`**     |   ✓   |    ✓     |   ✓    |    ✓     |   ✓   |     ✓     |     ✓      |
| **`unknown`** |   ✓   |    ✓     |   ✓    |    ✓     |   ✓   |     ✓     |     ✓      |
| **カスタム**  |   ✗   |    ✗     |   ✗    |    ✗     |   ✓   |     ✓     | 同名のみ ✓ |

---

## 5. 式の型付け規則

### 5.1 単項演算子

| 演算子 | オペランド型 | 結果型   |
| :----- | :----------- | :------- |
| `-`    | `int`        | `int`    |
| `-`    | `double`     | `double` |
| `!`    | `bool`       | `bool`   |

上記以外の組み合わせは型エラーです。

### 5.2 二項演算子

#### 5.2.1 算術演算 (`+`, `-`, `*`, `/`)

| 左オペランド | 右オペランド | 結果型   |
| :----------- | :----------- | :------- |
| `int`        | `int`        | `int`    |
| `int`        | `double`     | `double` |
| `double`     | `int`        | `double` |
| `double`     | `double`     | `double` |

例外:

- `string + string` → `string`（文字列連結）

#### 5.2.2 剰余演算 (`%`)

| 左オペランド | 右オペランド | 結果型 |
| :----------- | :----------- | :----- |
| `int`        | `int`        | `int`  |

`int` 以外のオペランドは型エラーです。

#### 5.2.3 比較演算 (`<`, `<=`, `>`, `>=`)

| 左オペランド | 右オペランド | 結果型 |
| :----------- | :----------- | :----- |
| 数値型       | 数値型       | `bool` |

数値型は `int` または `double` です。

#### 5.2.4 等価演算 (`==`, `!=`)

| 左オペランド | 右オペランド | 結果型 |
| :----------- | :----------- | :----- |
| 任意の型     | 互換型       | `bool` |

オペランドが互換でない場合は型エラーです。

#### 5.2.5 ビット演算 (`&`, `|`)

| 左オペランド | 右オペランド | 結果型 |
| :----------- | :----------- | :----- |
| `int`        | `int`        | `int`  |

`int` 以外のオペランドは型エラーです。

#### 5.2.6 論理演算 (`&&`, `||`)

| 左オペランド | 右オペランド | 結果型 |
| :----------- | :----------- | :----- |
| `bool`       | `bool`       | `bool` |

`bool` 以外のオペランドは型エラーです。

---

## 6. 型推論

### 6.1 ローカル変数の型推論

ローカル変数の型は以下の優先順位で決定されます：

1. **明示的な型注釈**がある場合: その型を使用
2. **初期値式**がある場合: 初期値の型を使用
3. **両方がない場合**: 型エラー

```bt-dsl
var x: int = 5      // 型は int（明示）
var y = 3.14        // 型は double（推論）
var z              // エラー: 型注釈または初期値が必要
```

### 6.2 Tree パラメータの型推論

Tree パラメータは型注釈が省略可能です。型注釈がない場合、型は `unknown`
として扱われ、すべての型と互換です。

---

## 7. 代入における型検査

### 7.1 単純代入 (`=`)

右辺の型は左辺の型と互換でなければなりません。

```bt-dsl
var x: int
x = 5        // OK
x = "hello"  // エラー: Cannot assign string to int
```

### 7.2 複合代入 (`+=`, `-=`, `*=`, `/=`)

| 演算子 | 許可される型の組み合わせ       |
| :----- | :----------------------------- |
| `+=`   | 数値同士、または `string` 同士 |
| `-=`   | 数値同士                       |
| `*=`   | 数値同士                       |
| `/=`   | 数値同士                       |

数値型は `int` または `double` です。
