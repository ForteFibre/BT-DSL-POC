# 1. 字句構造（Lexical Structure）

本章は、ソースコードのテキストを**トークン列**に変換するための規則を定義します。

- 本章は **意味（型、スコープ、実行）** には立ち入りません。
- 字句解析の結果は、以降の章（構文）で規定されるトークン列として扱われます。

---

## 1.1 ソースコード表現

### 1.1.1 文字エンコーディング

- ソースコードは **UTF-8** として解釈されなければなりません。
- 不正な UTF-8 バイト列を含む場合、処理系は**字句エラー**を報告しなければなりません。

### 1.1.2 改行コード

- 行終端は **LF (`\n`)** または **CRLF (`\r\n`)** を許容します。
- 行コメントは「行終端（line terminator）」までをコメント内容として扱います。

---

## 1.2 空白とコメント（Whitespace and Comments）

### 1.2.1 空白

空白は構文要素間で無視されます。

```ebnf
whitespace = /\s+/ ;
```

> [!NOTE]
> `\s`
> の具体的な集合（タブ、改行など）は処理系の正規表現実装に依存し得ますが、少なくとも ASCII の空白（SP、TAB、LF、CR）を含むものとして扱います。

### 1.2.2 コメント

```ebnf
line_comment  = "//" , /[^/!][^\n]*/ ;
block_comment = "/*" , /[^*]*\*+([^/*][^*]*\*+)*/ , "/" ;
comment       = line_comment | block_comment ;
```

- コメントは空白と同様に無視されます。
- ブロックコメントの入れ子（ネスト）は **未規定**（TBD）です。

### 1.2.3 ドキュメンテーションコメント

```ebnf
inner_doc = "//!" , /[^\n]*/ ;
outer_doc = "///" , /[^\n]*/ ;
```

- **Inner doc** (`//!`) は、モジュール（ファイル）先頭のドキュメントです。
- **Outer doc** (`///`) は、宣言・定義・ノード呼び出し等に付与されるドキュメントです。

---

## 1.3 識別子とキーワード（Identifiers and Keywords）

### 1.3.1 識別子

```ebnf
identifier = /[a-zA-Z_][a-zA-Z0-9_]*/ - keyword ;
```

- 識別子はキーワードと一致してはなりません（`- keyword`）。

### 1.3.2 予約語（Keywords）

以下はキーワードとして予約されます。

```text
import  extern  type  var  const  tree  as
in  out  ref  mut
true  false  null
vec

action  subtree  condition  control  decorator
```

> [!NOTE]
> 「将来の予約語」は現時点では別途規定しません（TBD）。

### 1.3.3 生識別子（Raw Identifiers）

- 生識別子（例: `r#type` のような形式）は **未サポート** です。

---

## 1.4 リテラル（Literals）

### 1.4.1 字句規則

```ebnf
string  = '"' , /([^"\\]|\\.)*/ , '"' ;
float   = [ "-" ] , /[0-9]+/ , "." , /[0-9]+/ ;
integer = "0" | [ "-" ] , /[1-9][0-9]*/ ;
boolean = "true" | "false" ;
null    = "null" ;
literal = string | float | integer | boolean | null ;
```

- `float` は `integer` より優先してトークン化されなければなりません（例: `123.456` は `float`）。

### 1.4.2 整数リテラル

- 許容されるのは上記 EBNF のとおり **10進**（符号 `-` を許容）です。
- 16進数・2進数・桁区切り（`_`）などは **未サポート** です。

### 1.4.3 浮動小数点リテラル

- `-?`、整数部、`.`, 小数部から成ります。
- 指数表記（`1e3` 等）は **未サポート** です。

### 1.4.4 文字列リテラル

- `"..."` で囲まれます。
- `\\` によるエスケープを許容します。
- 文字列リテラル中に**生の改行（LF/CRLF）** を含めてはなりません。改行を表すには `\n` を使用します。

処理系は、少なくとも次のエスケープシーケンスをサポートしなければなりません。

| 表記   | 意味                     |
| :----- | :----------------------- |
| `\\"`  | `"`（ダブルクオート）    |
| `\\\\` | `\\`（バックスラッシュ） |
| `\\n`  | LF (`0x0A`)              |
| `\\r`  | CR (`0x0D`)              |
| `\\t`  | TAB (`0x09`)             |
| `\\0`  | NUL (`0x00`)             |

> [!NOTE]
> 上表に含まれない `\\` から始まるシーケンス（例: `\\q`）の扱いは現状 **実装定義** です。

### 1.4.5 真偽値・Null

- 真偽値: `true` / `false`
- Null: `null`

---

## 1.5 記号と演算子（Punctuation and Operators）

### 1.5.1 区切り文字（Punctuation）

少なくとも次の記号は、独立したトークンとして扱われます。

- 区切り: `;` `,` `:`
- 括弧: `{` `}` `(` `)` `[` `]`
- 属性: `#` `[` `]`（構文上は `#[ ... ]` として使用）
- 事前条件: `@`

### 1.5.2 演算子トークン

- 代入: `=` `+=` `-=` `*=` `/=`
- 論理: `||` `&&` `!`
- ビット: `|` `&`
- 比較: `==` `!=` `<` `<=` `>` `>=`
- 算術: `+` `-` `*` `/` `%`
- キャスト: `as`

> [!NOTE]
> `?`（Nullable）や
> `<=`（上限付き型）などは、字句的には記号列として現れますが、どの構文位置で出現可能かは「構文」で規定します。
