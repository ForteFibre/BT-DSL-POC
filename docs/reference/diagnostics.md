# 5. 診断仕様（Diagnostics）

本章は、コンパイル時に検証される整合性ルール（エラー/警告）を定義します。

---

## 5.1 初期化安全性（Initialization Safety）

### 5.1.1 原則

1. `out` ポートに渡された変数は、ノードが `Success` を返した時点でのみ `Init`（初期化済み）とみなされます。
2. 事前条件によりノード本体の実行がスキップされた場合、`out` への書き込みは発生しません。
3. ノードが `Failure` の場合、`out` への書き込みは保証されません。

### 5.1.2 状態

| 状態     | 説明       |
| :------- | :--------- |
| `Uninit` | 未初期化   |
| `Init`   | 初期化済み |

### 5.1.3 DataPolicy

DataPolicy の定義とデフォルト値は [4.6.2 Behavior Policies](./semantics#_4-6-2-behavior-policies) を参照。

| Policy | 初期化安全性における意味                        |
| :----- | :-------------------------------------------- |
| `All`  | 親成功時、すべての子による書き込みが `Init`   |
| `Any`  | 親成功時、共通して書き込まれる変数のみ `Init` |
| `None` | 親成功時、子による書き込み保証は消滅         |

### 5.1.4 FlowPolicy

| Policy     | 初期化安全性における意味                             |
| :--------- | :--------------------------------------------- |
| `Chained`  | 前のノードの書き込み結果が次のノードで有効     |
| `Isolated` | すべての子は親開始時点の状態のみを参照可能     |

### 5.1.5 ノード呼び出し時の事前条件

| ポート方向 | 事前条件                         |
| :--------- | :------------------------------- |
| `in`       | 変数は `Init` でなければならない |
| `ref`      | 変数は `Init` でなければならない |
| `mut`      | 変数は `Init` でなければならない |
| `out`      | 変数は `Uninit` でも可           |

---

## 5.2 Null 安全性

### 5.2.1 Flow-Sensitive Typing

`@guard(expr)` / `@run_while(expr)` の条件が真であるスコープにおいて、Nullable 変数 `T?` を `T` に絞り込むことがあります。

### 5.2.2 条件式の分解規則

**null 比較**: `x != null` が真である場合、`x: T?` は `x: T` に絞り込まれます。

**連言**: `(a && b)` が真であるためには両辺が真である必要があるため、両辺に再帰的に適用します。

**否定**: `!p` が真である場合、`p` は偽です。

### 5.2.3 Nullable 変数の `out` 接続

`T?` 型の変数を `out T` に渡すことを許可します。

| ノード結果 | 変数の状態                  |
| :--------- | :-------------------------- |
| `Success`  | 非 `null` になる            |
| `Failure`  | 元の値（`null` など）のまま |

---

## 5.3 構造的制約

### 5.3.1 再帰呼び出しの禁止

`tree` の直接・間接の再帰呼び出しは**エラー**です。

### 5.3.2 未使用の `mut`/`out` の警告

`mut` または `out` として宣言された tree パラメータが一度も書き込みに使用されない場合、**警告**となります。

---

## 5.4 ポート方向と引数制約

### 5.4.1 引数方向とポート方向の整合性

| `arg_dir` \\ `port_dir` | `in` | `ref` | `mut` | `out` |
| :---------------------- | :--: | :---: | :---: | :---: |
| `in`（または省略）      | ✓    | Error | Error | Error |
| `ref`                   | Warn | ✓     | Error | Error |
| `mut`                   | Warn | Warn  | ✓     | Error |
| `out`                   | Error| Error | Error | ✓     |

### 5.4.2 引数の種類

- `in` : 任意の式（RValue）を指定可能
- `ref` : 左辺値（LValue）のみ
- `mut` / `out` : 左辺値（LValue）のみ

左辺値: 変数、tree パラメータ、配列要素
