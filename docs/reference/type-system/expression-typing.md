# 3.4 式の型規則（Expression Typing）

本ドキュメントは、式が評価されたときに得られる型（式の型）を定義します。

本章では、型付け判断を $\Gamma \vdash e : T$ と表記します。

- $\Gamma$ は型環境（識別子 → 型）
- $e$ は式
- $T$ は型

---

## 3.4.1 単項演算

### 算術否定 `-e`

- $\Gamma \vdash e : Int$（任意の整数型）のとき、$\Gamma \vdash -e : Int$
- $\Gamma \vdash e : Float$（`float32` または `float64`）のとき、$\Gamma \vdash -e : Float$

それ以外は型エラーです。

### 論理否定 `!e`

- $\Gamma \vdash e : bool$ のとき、$\Gamma \vdash !e : bool$

それ以外は型エラーです。

---

## 3.4.2 二項演算

### 算術演算（`+`, `-`, `*`, `/`）

数値型同士の演算は、両オペランドを共通の型へ揃えてから行います。

- 共通型は 3.3 の拡大変換（Widening）により到達可能な型のうち、両者を表現できる最小の型でなければなりません。
- その共通型を結果型とします。

特例:

- `string + string` は `string`（文字列連結）

> [!IMPORTANT]
> 符号付き整数と符号なし整数の混在（例: `int32 + uint32`）は **型エラー** です。
> 必要な場合は `as` による明示的キャストを使用してください。

### 剰余 `%`

- 両オペランドは整数型でなければなりません。
- 結果型は共通型（上記と同様）です。

### 比較（`<`, `<=`, `>`, `>=`）

- 両オペランドは数値型でなければなりません。
- 結果型は常に `bool` です。

### 等価（`==`, `!=`）

- オペランド同士が **値文脈（Value Compatibility）** で比較可能でなければなりません（3.3.1, 3.3.7）。
- 結果型は常に `bool` です。

### 論理（`&&`, `||`）

- 両オペランドは `bool` でなければなりません。
- 結果型は `bool` です。

### ビット演算（`&`, `|`）

- 両オペランドは整数型でなければなりません。
- 結果型は、3.3 の拡大変換により到達可能な共通型（存在する場合）のうち最小の型とします。

---

## 3.4.3 キャスト式

キャスト式 `e as T` は次の規則で型付けされます。

- $\Gamma \vdash e : S$ かつ、3.3.4 の規則に従って $S$ から $T$
  への明示的キャストが許容されるとき、$\Gamma \vdash (e \; as \; T) : T$

許容されない場合は型エラーです。

---

## 3.4.4 配列アクセス

配列要素アクセス `arr[index]` は次の規則で型付けされます。

### 要求される型

- $\Gamma \vdash index : I$ が整数型（符号付き/なし）でなければなりません。
- `arr` は `[T; N]`、`[T; <=N]`、または `vec<T>` でなければなりません。

### 結果型

- `arr: [T; N]` のとき、`arr[index] : T`
- `arr: [T; <=N]` のとき、`arr[index] : T`
- `arr: vec<T>` のとき、`arr[index] : T`

### 境界チェック（定数インデックス）

処理系は、次の場合に限り境界チェックをコンパイル時に行わなければなりません。

- 配列が静的配列であり、$N$ がコンパイル時定数
- `index` がコンパイル時定数（定数式として評価可能）

このとき、次を満たさない場合はコンパイルエラーです。

- `arr: [T; N]` の場合: $0 \le index < N$
- `arr: [T; <=N]` の場合: $0 \le index < N$ を満たさない（すなわち $index \ge N$）場合は、上限 $N$ を超えるため常に不正です。
  - ただし $0 \le index < N$ の範囲でも、実際の現在長（length）に対する境界内かはコンパイル時に決定できないことがあります。

上記以外の場合（例: 実行時に決まる `index`、`vec<T>` など）の境界チェックの有無・例外・未定義動作は
**実装定義** です。
