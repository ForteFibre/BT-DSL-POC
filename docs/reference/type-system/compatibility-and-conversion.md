# 3.3 互換性と変換（Compatibility and Conversion）

本ドキュメントは、型 $S$ の値を型 $T$ として扱えるか（代入・引数渡しの可否）と、型変換の規則を定義します。

---

## 3.3.1 基本概念

本章では次を区別します。

- **暗黙変換（implicit coercion）**: `as` を書かずに成立する変換
- **明示的キャスト（explicit cast）**: `as` により成立する変換

また、型名がエイリアスである場合は、比較前に実体型へ展開（正規化）されなければなりません。

---

## 3.3.2 互換性の要約（Summary）

本節は要約です。規範は 3.3.3 以降にあります。

| 位置/形態            | 同一型 | 拡大（Widening） | 縮小（Narrowing） | 配列・外部型 |
| :------------------- | :----: | :--------------: | :---------------: | :----------- |
| 代入 (`=`)           |   ✓    |       ✓          |     ✗（`as`）     | 規則による   |
| `in` 引数            |   ✓    |       ✓          |     ✗（`as`）     | 規則による   |
| `ref` / `mut` 引数   |   ✓    |        ✗         |        ✗          | 完全一致のみ |
| `out` 引数           |   ✓    |   ✓（出力拡大）  |        ✗          | 規則による   |

---

## 3.3.3 暗黙の型変換（Implicit Coercion）

### 拡大変換（Widening）

整数型および浮動小数型には、安全な拡大変換（情報落ちが無い変換）が定義されます。

| 変換元    | 変換先                       |
| :-------- | :--------------------------- |
| `int8`    | `int16`, `int32`, `int64`    |
| `uint8`   | `uint16`, `uint32`, `uint64` |
| `int16`   | `int32`, `int64`             |
| `uint16`  | `uint32`, `uint64`           |
| `int32`   | `int64`                      |
| `uint32`  | `uint64`                     |
| `float32` | `float64`                    |

これらの拡大変換は、少なくとも次の位置で暗黙に許容されます。

- 代入
- `in` 引数
- `out` 引数（後述）

> [!IMPORTANT]
> `ref` / `mut` は参照引数であるため、暗黙変換を許容してはなりません（3.3.7）。

### Out ポートの拡大（Output Widening）

`out` ポートの宣言型が小さい場合に、それをより大きい変数で受けることを許可します。

例: `out int8` を `int32` の変数で受ける。

---

## 3.3.4 明示的キャスト（`as`）

`as` は、式の値を指定した型へ変換します。

- 縮小変換（例: `int32 -> int8`）は `as` が必須です。
- 配列の変換など、コストや意味が明確でない変換は `as` が必須です。

> [!NOTE]
> 縮小変換の結果（オーバーフロー、丸めなど）の詳細な数値意味論は **規定しません**。
> これは処理系および実行環境に依存します（environment/implementation-defined）。
> 処理系は少なくとも「情報落ちが起こり得る」ことを前提に、静的解析や警告を行っても構いません。

---

## 3.3.5 配列の互換性

### 静的配列同士

- `[T; N]` は `[T; N]` にのみ暗黙に代入可能です。
- `N` が異なる場合（`N ≠ M`）は不一致です。

### 上限付き静的配列

上限付き静的配列について、次を許容します。

- `[T; N] -> [T; <=M]` は $N \le M$ のときのみ許容
- `[T; <=N] -> [T; <=M]` は $N \le M$ のときのみ許容

逆方向（上限が大きいものを小さいものへ）は許容されません。

### 動的配列

- `vec<T>` は `vec<T>` にのみ暗黙に代入可能です。

### 静的配列 ↔ 動的配列

- 静的配列から動的配列への暗黙変換は禁止です。
- 静的配列を `vec<T>` として扱うには、明示的キャストが必要です（例: `[1,2,3] as vec<_>`）。

> [!NOTE]
> `vec<T>` の代入が「参照コピー」か「値の複製」か等の実行時挙動は **実装定義** です。

---

## 3.3.6 上限付き文字列の互換性

上限付き文字列 `string<=N` は、上限値を含む別型です。

| 変換元         | 変換先         | 判定              |
| :------------- | :------------- | :---------------- |
| `string<=N`    | `string<=M`    | 許容 iff $N \le M$ |
| `string<=N`    | `string`       | 許容               |
| `string`       | `string<=N`    | 不許容             |

---

## 3.3.7 引数渡しにおける互換性

### `in` / 代入

（3.3.3 の暗黙変換と 3.3.4 の `as` に従う）

- 同一型は許容。
- 拡大変換は暗黙に許容。
- 縮小変換は `as` が必須。

### `ref` / `mut`

`ref` / `mut` は参照引数であり、別型に対する参照を作ることはできません。

- 型は **正規化後に完全一致**しなければなりません（Invariant）。

> [!NOTE]
> この規則は、型安全性（参照先の表現と操作が一致すること）を保証するために必要です。

### `out`

- 型は完全一致が基本です。
- ただし **Output Widening** により、出力側が小さい数値型で受け手が大きい数値型である場合に限り、暗黙に許容されます。

---

## 3.3.8 外部型（Opaque Type）の互換性

- 外部型は同名同士でのみ互換です。
- 他のいかなる型とも（拡大/縮小/キャストを含め）互換ではありません。
