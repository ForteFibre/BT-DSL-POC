# 4. 意味論: 宣言とスコープ（Semantics: Declarations and Scopes）

本章は、プログラムの静的構造に関する意味論（宣言、名前空間、スコープ、名前解決、可視性）を定義します。

---

## 4.1 名前空間と可視性（Namespaces and Visibility）

### 4.1.1 名前空間の分離

BT-DSL は少なくとも次の名前空間を持ち、互いに衝突しません。

- **Type 空間**: 基本型、`extern type`、`type`（エイリアス）
- **Node 空間**: `extern` ノード名、`tree` 名
- **Value 空間**: Blackboard（`var`）、定数（`const`）、パラメータ

> [!NOTE] 同名でも名前空間が異なれば共存できます（例: `extern type A;` と `tree A()`）。

### 4.1.2 可視性（Visibility）

ファイル間参照（import）における可視性は、識別子の命名規則で規定します。

| 識別子の先頭文字     | 可視性      | 説明                                                       |
| :------------------- | :---------- | :--------------------------------------------------------- |
| `_` (アンダースコア) | **Private** | 定義されたファイル内でのみ参照可能。外部からは見えません。 |
| その他               | **Public**  | `import` した他ファイルから参照可能。                      |

> [!IMPORTANT] `import` の探索・パッケージ解決の詳細は **実装定義**
> です。本仕様は「Private は参照できない」「Public は参照可能」という言語レベルの要請のみを規定します。

---

## 4.2 スコープと名前解決（Scopes and Name Resolution）

### 4.2.1 スコープ階層

| スコープ      | 含まれる宣言（代表例）                                            |
| :------------ | :---------------------------------------------------------------- |
| グローバル    | `extern`、`extern type`、`type`、グローバル `var`/`const`、`tree` |
| Tree ローカル | tree パラメータ、ローカル `var`/`const`                           |
| ブロック      | `children_block` 内の `var`/`const`、インライン `out var`         |

### 4.2.2 名前解決の優先順位

識別子の解決は次の順序で行われます。

1. ブロックスコープ（`children_block` 内の `var`/`const`）
2. Tree ローカル（パラメータ、ローカル `var`/`const`）
3. グローバル（グローバル `var`/`const`）

### 4.2.3 重複とシャドウイング

- 同一スコープ内で同名の宣言はできません。
- 親スコープの同名識別子の隠蔽（シャドウイング）は **禁止** です。

同一スコープ内で禁止される代表的な重複は次のとおりです。

- **Type 空間**: `extern type` 同士 / `type` 同士 / `extern type` と `type` / 基本型名との衝突
- **Node 空間**: `extern` ノード同士 / `tree` 同士 / `extern` と `tree`
- **Value 空間**: 同一スコープ内の `var`/`const`/パラメータ同士

> [!IMPORTANT] 名前空間が異なる場合は衝突しません（例: `extern type A;` と `tree A()`）。

### 4.2.4 宣言前参照

- Value 空間（`var`/`const`/パラメータ）の参照は、**宣言以降**でなければなりません。
- Type / Node 空間の前方参照可否は **未規定**（TBD）です。

---

## 4.3 定数評価（Constant Evaluation）

### 4.3.1 定数式

- `const` の初期化式、および `extern`/`tree` のデフォルト引数は `const_expr` でなければなりません。
- `const_expr` の構文は [構文 - 定数式](./syntax.md#_2-7-定数式constant-expressions)
  を参照してください。

### 4.3.2 参照可能な識別子

- `const_expr` 内の `identifier` は、**既に定義済みの `const`** を参照できます。
- 循環参照は **コンパイルエラー** です。

### 4.3.3 コンパイル時評価の制約

- `const_expr` は、実行時値（Blackboard、`out` の結果など）を参照してはなりません。
- 評価順序・数値演算のオーバーフロー/丸め等の詳細は **規定しません**。
  これらは処理系および実行環境に依存します（environment/implementation-defined）。
