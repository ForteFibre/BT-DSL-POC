# 型システム — 補足情報

本ドキュメントは [型システム（言語仕様）](../reference/type-system.md) の補足情報です。

---

## 設計根拠

### 型表記と型構造の分離

型の**表記（構文）**は [構文 2.3節](../reference/syntax.md#23-型の構文type-syntax) で定義されます。
型システム仕様は、その表記が意味する**型の構造**（振る舞い）を定義しています。
この分離により、構文変更が型システムの規則に影響を与えにくくなっています。

### int/float の混合演算を禁止する理由

BT-DSL は厳密性を重視し、`int` と `float` の暗黙の共通型推論を行いません。
これにより、意図しない精度損失や型変換を防ぎます。
混合演算が必要な場合は `as` による明示的キャストを使用してください。

### ref/mut の Invariant 制約

`ref` / `mut` は参照引数であり、別型に対する参照を作ることはできません。
型は**正規化後に完全一致**しなければなりません。
この規則は、型安全性（参照先の表現と操作が一致すること）を保証するために必要です。

---

## 実装定義事項

以下は言語仕様で規定せず、処理系に委ねられる事項です。

| 事項 | 説明 |
| :--- | :--- |
| 数値の内部表現 | 2の補数、IEEE 754 等は規定しない |
| オーバーフロー挙動 | 縮小変換時の丸め・飽和・wraparound は実装定義 |
| `vec<T>` のメモリ配置 | クローン/ムーブのコストは実装定義 |
| `vec<T>` の代入挙動 | 参照コピー/値の複製かは実装定義 |
| 境界チェック（実行時） | 有無・例外・未定義動作は実装定義 |

---

## 未規定事項（TBD）

| 事項 | 説明 |
| :--- | :--- |
| `[T; <=N]` の length 取得 | length を取得する式や API は未規定 |
| 組み込みエイリアス | `int`, `float`, `byte` 等の提供有無は未確定 |

### 組み込みエイリアス候補

処理系は利便性のため、以下のエイリアスを提供してよいものとします。

| エイリアス      | 実体型    |
| :-------------- | :-------- |
| `byte` / `char` | `uint8`   |
| `int`           | `int32`   |
| `float`         | `float32` |
| `double`        | `float64` |

---

## コード例

### 型推論ワイルドカードの使用

```bt-dsl
vec<_>           // 要素型を推論
[_; 5]           // 要素型を推論、サイズは 5 に固定
var x: _? = 1.0; // ベース型を推論して T? とする
```

### 配列リテラルの型推論

| リテラル構文   | 推論される型 |
| :------------- | :----------- |
| `[e1, e2, e3]` | `[T; 3]`     |
| `[e; N]`       | `[T; N]`     |
| `vec![e1, ...]`| `vec<T>`     |
| `vec![e; N]`   | `vec<T>`     |

上限付き静的配列 `[T; <=N]` はリテラルからは推論されません。型注釈で指定してください。

### 文脈型付け

```bt-dsl
// 期待型が [T; <=N] のとき
var arr: [int32; <=5] = [1, 2, 3];  // OK: [int32; <=5]

// 期待型が string<N> のとき
var s: string<10> = "hello";  // OK: string<10>
```

### 共通上位型の推論

| 制約             | 解決先     |
| :--------------- | :--------- |
| `int8` + `int16` | `int16`    |
| `float32` + `float64` | `float64` |
| `int` + `bool`   | **エラー** |
| `int` + `float`  | **エラー**（明示的キャスト必須） |

### 符号付き/符号なしの混在

```bt-dsl
var a: int32 = 10;
var b: uint32 = 20;
var c = a + b;  // エラー: 符号付き/符号なし混在
var d = a + (b as int32);  // OK: 明示的キャスト
```

---

## 処理系実装者向け

### 型推論ワイルドカードと内部型変数

`_` や `_?` は構文上のワイルドカード（型推論要求）であり、内部型 `?`（型変数）とは別物です。

処理系は:
- `_` が現れた位置に対して新しい未解決型変数を導入
- `_?` が現れた位置に対しては「Nullable であることが確定した」未解決型変数を導入

### 外部型の名前解決

異なるモジュールがそれぞれ `extern type Pose;` を定義している場合、
`Pose` が参照位置で一意に解決できないなら、曖昧性によりコンパイルエラーとします。
